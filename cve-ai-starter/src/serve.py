# src/serve.py
from fastapi import FastAPI
from pydantic import BaseModel
from transformers import AutoTokenizer, AutoModelForSequenceClassification
import torch


app = FastAPI(title='CVE Severity Classifier')


MODEL_DIR = 'models/cve_severity'
LABELS = {0: 'low', 1: 'medium', 2: 'high'}
REMEDIATIONS = {
'low': 'Monitor the vendor advisory; apply routine patching.',
'medium': 'Investigate affected versions and prioritize patching in next maintenance window.',
'high': 'Immediate patching or mitigations recommended; consider isolating affected hosts.'
}


class CVEIn(BaseModel):
description: str


@app.on_event('startup')
def load_model():
global tokenizer, model
tokenizer = AutoTokenizer.from_pretrained(MODEL_DIR)
model = AutoModelForSequenceClassification.from_pretrained(MODEL_DIR)
model.eval()


@app.post('/predict')
def predict(payload: CVEIn):
inputs = tokenizer(payload.description, truncation=True, padding=True, return_tensors='pt', max_length=256)
with torch.no_grad():
logits = model(**inputs).logits
probs = torch.softmax(logits, dim=-1).squeeze().tolist()
pred = int(torch.argmax(logits, dim=-1).item())


label = LABELS[pred]
return {
'label': label,
'confidence': max(probs),
'remediation': REMEDIATIONS[label]
}