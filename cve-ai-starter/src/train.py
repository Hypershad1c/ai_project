# src/train.py
from datasets import load_dataset
from transformers import AutoTokenizer, AutoModelForSequenceClassification, TrainingArguments, Trainer
import torch
import os


MODEL_NAME = 'distilbert-base-uncased'
OUTPUT = os.path.join(os.path.dirname(__file__), '..', 'models', 'cve_severity')




def main():
ds = load_dataset('csv', data_files=os.path.join('data', 'processed', 'cve_dataset.csv'))
tokenizer = AutoTokenizer.from_pretrained(MODEL_NAME)


def preprocess(batch):
return tokenizer(batch['description'], truncation=True, padding='max_length', max_length=256)


ds = ds['train'].train_test_split(test_size=0.15)
ds = ds.map(preprocess, batched=True)
ds.set_format(type='torch', columns=['input_ids', 'attention_mask', 'label'])


model = AutoModelForSequenceClassification.from_pretrained(MODEL_NAME, num_labels=3)


training_args = TrainingArguments(
output_dir=OUTPUT,
evaluation_strategy='epoch',
per_device_train_batch_size=8,
per_device_eval_batch_size=8,
num_train_epochs=3,
save_total_limit=2,
)


trainer = Trainer(
model=model,
args=training_args,
train_dataset=ds['train'],
eval_dataset=ds['test'],
tokenizer=tokenizer,
)


trainer.train()
trainer.save_model(OUTPUT)




if __name__ == '__main__':
main()