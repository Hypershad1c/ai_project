# src/preprocess.py
import os
import json
import pandas as pd
from pathlib import Path


ROOT = Path(__file__).resolve().parent.parent
RAW = ROOT / 'data' / 'raw'
OUT = ROOT / 'data' / 'processed'
OUT.mkdir(parents=True, exist_ok=True)


# Simple parser for NVD JSON structure. Adjust keys depending on feed version.


def parse_nvd_json(filepath):
with open(filepath, 'r', encoding='utf-8') as f:
obj = json.load(f)


items = obj.get('CVE_Items', [])
rows = []
for it in items:
desc = ''
try:
desc = it['cve']['description']['description_data'][0]['value']
except Exception:
desc = ''


# Try to extract CVSS v3 score if present
cvss = None
try:
cvss = it['impact']['baseMetricV3']['cvssV3']['baseScore']
except Exception:
cvss = None


rows.append({'description': desc, 'cvss': cvss})


return pd.DataFrame(rows)




def cvss_to_label(score):
# buckets: 0-3 Low (0), 3.1-6.9 Medium (1), 7.0-10 High (2)
if score is None:
return 1 # unknown -> medium by default (you can change)
s = float(score)
if s <= 3.0:
return 0
if s <= 6.9:
return 1
return 2




if __name__ == '__main__':
dfs = []
for f in RAW.glob('*.json'):
print('Parsing', f)
df = parse_nvd_json(f)
dfs.append(df)


if not dfs:
print('No raw files found. Put NVD JSON files into data/raw.')
exit(1)


all_df = pd.concat(dfs, ignore_index=True)
all_df['label'] = all_df['cvss'].apply(lambda x: cvss_to_label(x))
# drop empty descriptions
all_df = all_df[all_df['description'].str.strip() != '']
out_path = OUT / 'cve_dataset.csv'
all_df.to_csv(out_path, index=False)
print('Wrote', out_path)